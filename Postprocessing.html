<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="img/favicon.ico">
        <title>Postprocessing - Project Eucalyptus ðŸŒ¿</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/fontawesome.min.css" rel="stylesheet">
        <link href="css/brands.min.css" rel="stylesheet">
        <link href="css/solid.min.css" rel="stylesheet">
        <link href="css/v4-font-face.min.css" rel="stylesheet">
        <link href="css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="index.html">Project Eucalyptus ðŸŒ¿</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="index.html" class="nav-link">Introduction</a>
                            </li>
                            <li class="nav-item">
                                <a href="Data.html" class="nav-link">Data</a>
                            </li>
                            <li class="nav-item">
                                <a href="Radiative_Transfer.html" class="nav-link">Radiative transfer</a>
                            </li>
                            <li class="nav-item">
                                <a href="Model.html" class="nav-link">Model</a>
                            </li>
                            <li class="nav-item">
                                <a href="Validation.html" class="nav-link">Validation</a>
                            </li>
                            <li class="nav-item">
                                <a href="Postprocessing.html" class="nav-link active" aria-current="page">Postprocessing</a>
                            </li>
                            <li class="nav-item">
                                <a href="Landsat.html" class="nav-link">Landsat</a>
                            </li>
                            <li class="nav-item">
                                <a href="Hyperspectral.html" class="nav-link">Hyperspectral</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="Validation.html" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="Landsat.html" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/Orbio-Earth/Project-Eucalyptus" class="nav-link"><i class="fa-brands fa-github"></i> GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#postprocessing" class="nav-link">Postprocessing</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#_1" class="nav-link"></a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="postprocessing">Postprocessing</h1>
<h3 id="how-are-individual-plumes-masked-segmented-out-of-the-inference-output">How are individual plumes masked (segmented) out of the inference output?</h3>
<p>The masking stage in the methane detection pipeline is designed to convert sensor outputs into binary masks that isolate methane plume signals. Our masking is performed on a binary probability map that represents the likelihood of methane presence at each pixel. We use a watershed segmentation algorithm, a classical image processing technique that treats the probability map as a topographic surface. High-probability pixels are treated as peaks, and the algorithm simulates a flood from selected seed points to delineate coherent plume structures. Parameters such as minimum distance between markers, thresholding for plume regions, and gradient-based seed selection are tuned to optimize segmentation across different sensors and models. The final output is a binary raster mask, with pixels labeled as 1 indicating methane-positive detections and zero representing methane-negative pixels.</p>
<p>We experimented with doing the segmentation on marginal and conditional retrievals as well, but found that the binary probability map produced the best plume delineation. The implementation of the masking can be found in the methane-cv repo here:  https://github.com/Orbio-Earth/Eucalyptus-code-archive/blob/main/methane-cv/sbr_2025/utils/prediction.py#L225</p>
<h3 id="how-do-you-estimate-the-emissions-rate-for-a-plume">How do you estimate the emissions rate for a plume?</h3>
<p>Plume quantification is performed using the <strong>Integrated Mass Enhancement (IME)</strong> method, which is the standard approach for estimating methane emission rates from satellite observations, see Varon et al. (2018). IME represents the total methane enhancement within a segmented plume and is combined with wind data to estimate the source emission rate (<strong>Q</strong>). The core relationship is defined as:</p>
<p><strong>Q \= IME / Ï„</strong></p>
<p>where <strong>Ï„</strong> is the effective residence time of methane within the detectable plume. This residence time is operationally defined as the plume length divided by wind speed, or:</p>
<p><strong>Ï„ \= L / U_eff</strong></p>
<p>Here, <strong>L</strong> is the effective plume length, calculated as the longest side of the bounding rectangle that encloses the segmented plume area, and <strong>U_eff</strong> is the effective wind speed, obtained from ERA5 or GEOSS meteorological reanalysis data at the time and location of the plume.</p>
<p>The final formula used to estimate methane emissions, expressed in kilograms per hour, is:</p>
<p><strong>Q \= (U_eff / L) Ã— IME Ã— 57.75286</strong></p>
<p>This equation incorporates the molecular weight of methane (16.04246 g/mol) and converts the emission rate from moles per second to kilograms per hour using the constant 57.75286.</p>
<p>The <strong>IME</strong> itself is calculated by summing the methane enhancements (in mol/mÂ²) across all pixels identified as plume-positive in the binary mask and multiplying by the pixel area (derived from the spatial resolution of the raster). Only pixels with enhancement values above zero are included. The raster used for this summation is the <strong>rescaled retrieval</strong>, which contains column methane values in physical units (the rescaled retrieval is explained in the section below).</p>
<p>The quantification module in the methane-cv repo is located here: https://github.com/Orbio-Earth/Eucalyptus-code-archive/blob/main/methane-cv/src/inference</p>
<h3 id="why-do-you-use-the-rescaled-retrieval-for-quantification">Why do you use the rescaled retrieval for quantification?</h3>
<p>Classical methods for methane detection and emissions quantification directly produce a "retrieval" raster of methane concentration point estimates for each pixel in a scene. This same retrieval is used for masking and then quantification of the masked retrieval.</p>
<p>With the computer vision approach, the output is probabilistic, with interpretation further discussed in the <a href="Data.html">Data</a> section. The prediction is in two parts: the binary probability and the conditional frac, which is converted into a conditional retrieval by inverting the radiative transfer laws.</p>
<p>When it comes to masking, we have already discussed that we perform the masking on the binary probability channel, rather than the retrieval. But what is the analog of the masked retrieval used for quantification? There are two obvious options, but they both have significant downsides.</p>
<p><strong>Masking the conditional retrieval.</strong> Once a plume has been accepted, via a QA or automated process, the conditional retrieval answers the question "if there is methane in this pixel, then how much?" so it therefore seems natural to mask the conditional retrieval for quantification. But experiments with controlled releases showed that resulting quantifications significantly overestimate the ground truth emission rate, with a mean absolute percentage error measured above +50% in 8 controlled releases. This is because the tail of the plume, where the presence of methane above the threshold has low probability, gets treated as if it definitely contained methane. Visually, these masked plumes with boosted tails also have cliff edges at their perimeter, which is suggestive of the problem.</p>
<p><strong>Masking the marginal retrieval.</strong> The marginal retrieval is the conditional retrieval weighted by the binary probability, and is an analog to the output of the classical retrieval algorithms. By definition, it is lower than the conditional retrieval, and so results in lower quantifications. Visually, it also has smoother tails, without the cliff edge effect observed in the masked conditional retrieval. However, for a plume with low likelihood, the quantification is in effect weighted down by the model's probability of the plume not existing at all. One can think of this as a form of regularization. If such a plume is nevertheless selected in QA, this downweighting is inappropriate, and leads to underestimating the emission rate if the plume is real. It is also troubling that the binary probability is internally calibrated to the computer vision model's training data (more frequent plumes in training data \= generally higher predicted probabilities), with no direct real-world interpretation, and this bias will translate directly to the quantification.</p>
<p>The downsides of the conditional and marginal retrievals for quantification motivated the development of the <strong>rescaled retrieval</strong>, which is obtained <em>after masking</em>, by dividing the marginal retrieval by the maximum binary probability <em>within each plume</em>. This has several advantages:</p>
<ol>
<li>the tails of the plumes are not boosted inappropriately;</li>
<li>there is no cliff edge at the perimeter of the plume; and</li>
<li>the quantification is not highly sensitive to the frequency of plumes in the training data.</li>
</ol>
<p>There is an (admittedly fuzzy) probabilistic interpretation of the rescaled retrieval. The binary prediction for each pixel can be factored into two components: (1) the probability of the methane plume that this pixel belongs to being real, and (2) the conditional probability of this particular pixel exceeding the threshold given that the plume is real. By dividing by the maximum pixel probability within the plume, we are eliminating the first factor, because we are quantifying a plume assuming it is real. But the second factor remains, and tempers down the estimated concentrations in the more uncertain tails of the plume.</p>
<h3 id="what-sources-of-wind-data-can-be-used">What sources of wind data can be used?</h3>
<p>Any wind data source can be used, as long as it provides reliable wind speed and direction estimates near the surface, ideally with spatial resolution down to at least around 25km and temporal resolution of 1â€“3 hours. The better the resolution, the more accurate the emission quantification.</p>
<p>We typically use <a href="https://gmao.gsfc.nasa.gov/GMAO_products/NRT_products.php">GEOS-FP (NASA GMAO)</a> and cross-check against <a href="https://www.ecmwf.int/en/forecasts/dataset/ecmwf-reanalysis-v5">ERA5 (ECMWF Reanalysis)</a>. Both are freely available, provide global coverage, and offer spatial resolution of around 25km. GEOS-FP has a 3-hour temporal resolution, while ERA5 provides data hourly. While ERA5 is generally considered more accurate, in practice weâ€™ve found both datasets yield similar results for methane detection. The bigger opportunity for improvement would come from using higher-resolution wind data to better capture local wind behavior. That said, in a real-time production setting, ERA5 is often less practical due to slower availability and longer download times.</p>
<h1 id="_1"></h1></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = ".",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="js/base.js"></script>
        <script src="javascripts/mathjax.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
